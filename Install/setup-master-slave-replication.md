1. Chuẩn bị

Master: 10.255.76.34
Slave: 10.255.76.35

2. Cài đặt PostgresSQL 13 trên 02 Node Ubuntu
```
#Add a GPG key
curl https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/apt.postgresql.org.gpg >/dev/null

#Add PostgreSQL repository on Ubuntu 22.04
echo "deb [arch=amd64] http://apt.postgresql.org/pub/repos/apt/ jammy-pgdg main" | sudo tee /etc/apt/sources.list.d/postgresql.list

#Rebuild APT index cache
sudo apt update

#Install PostgresSQL 13 on Ubuntu 22.04
apt install postgresql-13 postgresql-client-13
```

3. Sau khi cài đặt xong các đường dẫn sẽ như sau

```
File config: /etc/postgresql/13/main/

data_directory = '/var/lib/postgresql/13/main' 
hba_file = '/etc/postgresql/13/main/pg_hba.conf' 
ident_file = '/etc/postgresql/13/main/pg_ident.conf' 
external_pid_file = '/var/run/postgresql/13-main.pid'
stats_temp_directory = '/var/run/postgresql/13-main.pg_stat_tmp'
```
4.  Thay đổi đường dẫn mặc định

Tạo đường dẫn mới
```
mkdir -p /database/postgresql/13/
chown -R postgres:postgres /database/postgresql

su - postgres
mkdir -p  /database/postgresql/13/main
mkdir -p  /database/postgresql/13/logs
mkdir -p  /database/postgresql/13/archive
```

Thực hiện sửa đổi đường dẫn cấu hình mặc định file /etc/postgresql/13/main/postgresql.conf
```
data_directory = '/database/postgresql/13/main' 
```

Thực hiện stop database
```
systemctl stop postgresql@13-main.service
```

Chuyển dữ liệu từ /var/lib/postgresql/13/main sang /database/postgresql/13/main

```
sudo rsync -av /var/lib/postgresql/13/main /database/postgresql/13/
mv /var/lib/postgresql/13/main /var/lib/postgresql/13/main.bakyyyymmdd
```

Thực hiện start database
```
systemctl start postgresql@13-main.service
systemctl status postgresql@13-main.service
```

Check đường dẫn tiến trình
```
ps aux | grep postgres | grep -- -D

postgres  167951  0.0  0.0 218156 30764 ?        Ss   11:38   0:00 /usr/lib/postgresql/13/bin/postgres -D /database/postgresql/13/main -c config_file=/etc/postgresql/13/main/postgresql.conf
```

5. Cấu hình Trên server Master

```
vi /etc/postgresql/13/main/postgresql.conf
listen_addresses = '*'
wal_level = replica
archive_mode = on
archive_command = 'cp %p /database/postgresql/13/wal_archive/%f'
restore_command = 'cp /database/postgresql/13/wal_archive/%f %p'

su  - postgres
mkdir -p /database/postgresql/13/wal_archive
cd /database/postgresql/13
chmod 700 wal_archive
```

6. Cấu hình Network trên server Master cho server Slave kết nối
```
CREATE ROLE replication WITH REPLICATION PASSWORD 'replication' LOGIN;
```
Cấu hình file pg_hba.conf để cho phép từ Salve có thể kết nối được Master thông qua user replication
```
vi /etc/postgresql/13/main/pg_hba.conf

host    replication     all             10.255.76.34/32   trust
host    replication     all             10.255.76.35/32   trust
```

7. Resart Postgres máy chủ Master
```
systemctl restart postgresql@13-main.service
```
8. Cấu hình trên máy chủ Slave
```
vi /etc/postgresql/13/main/postgresql.conf
listen_addresses = '*'
wal_level = replica
archive_mode = on
archive_command = 'cp %p /database/postgresql/13/wal_archive/%f'
restore_command = 'cp /database/postgresql/13/wal_archive/%f %p'

su  - postgres
mkdir -p /database/postgresql/13/wal_archive
cd /database/postgresql/13
chmod 700 wal_archive
```
9. Tạo thư mục data Postgres máy chủ Slave
```
systemctl stop postgresql@13-main.service
su - postgres
mv /database/postgresql/13/main /database/postgresql/13/main_bkyyyymmdd
cd /database/postgresql/13/
mkdir main
chmod 700 main
```
10. Backup và restore trên server Slave
```
pg_basebackup -h 10.255.76.34 -p 5432 -U replication -D /database/postgresql/13/main -Fp -Xs -R --slot=standby_repl_sot -C
```
Câu lệnht rên sẽ kết nối vào Master, backup toàn bộ thư mục pgdata của Master và restore sang Slave. Option -R sẽ tạo ra trên slave 1 file có tên là standby.signal. File này có nhiệm vụ báo hiệu đây là database slave.

Ngoài ta, nếu bạn kiểm tra file postgresql.auto.conf sẽ thấy có thêm tham số sau (tham số này cũng do option -R tạo ra)
```
-rw-------  1 postgres postgres    455 Sep  8 16:11 postgresql.auto.conf
-rw-------  1 postgres postgres      0 Sep  8 16:11 standby.signal
root@dc-prd-ast-smsgw-db02:/database/postgresql/13/main# cat postgresql.auto.conf
# Do not edit this file manually!
# It will be overwritten by the ALTER SYSTEM command.
primary_conninfo = 'user=replication passfile=''/var/lib/postgresql/.pgpass'' channel_binding=prefer host=10.255.76.34 port=5432 sslmode=prefer sslcompression=0 sslcertmode=allow sslsni=1 ssl_min_protocol_version=TLSv1.2 gssencmode=prefer krbsrvname=postgres gssdelegation=0 target_session_attrs=any load_balance_hosts=disable'
primary_slot_name = 'standby_repl_sot'
```

Tham số này để chỉ ra thông tin kết nối đến master, từ đó slave có thể sử dụng để kết nối vào slave để kéo WAL file về.

11. Start postgesql trên server Slave
```
systemctl start postgresql@13-main.service
```

12. Kiểm tra tiến trình replication
```
select * from pg_stat_replication;
select * from pg_stat_wal_receiver;
```

Note:
- Restart Master or Salve tiến trình đồng bộ tự động apply
- Stop Slave, khi Start lại Slave tiến trình tự động apply các thay đổi từ Master sang Slave
